<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admins Portal</title>
  
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="../../css/portals/admins-portal/admins-portal.css">
  <link rel="stylesheet" href="../../css/portals/admins-portal/school-calendar.css">
  <!-- **NEW**: Add SheetJS library for reading/writing Excel files -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

    <script src="../../js/shared/firebase-config.js"></script>
    <script src="../../js/portals/admins-portal/report-card-generator.js"></script>
    <script src="../../js/portals/admins-portal/sorting-utils.js"></script> 	
    <script src="../../js/portals/admins-portal/data-functions.js"></script>
    <script src="../../js/portals/admins-portal/data-export-functions.js"></script>
    <script src="../../js/portals/admins-portal/calendar-manager.js"></script>
    <script src="../../js/portals/admins-portal/ui-handlers.js"></script> 	
    <script src="../../js/portals/admins-portal/sams-data-loaders.js"></script> 	
    <script src="../../js/portals/admins-portal/lms-manager.js"></script> 	
    <script src="../../js/portals/admins-portal/grade-assignment-tool.js"></script> 
    <script src="../../js/portals/admins-portal/parent-data-manager.js"></script>
    <script type="module" src="../../js/portals/admins-portal/ems-manager.js"></script>	
    <!-- Removed redundant data loading scripts, consolidated into data-functions.js -->

    <!-- initialization relies on globals from the portal scripts above -->
    <script src="../../js/portals/admins-portal/main-initialization.js"></script>

    <!-- auth.js uses ES module imports — load it as a module and expose logout to window (see auth.js change) -->
    <script type="module" src="../../js/auth/auth.js"></script>

    <style id="print-styles">
      @media print {
        /* **FIX**: Instead of hiding everything, hide specific non-printable sections */
        body > header, .portal-main-content {
          display: none !important;
        }

        #print-container, #print-container * { visibility: visible; }
        #print-container {
          display: block !important; /* Ensure the container itself is visible */
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
        }
        .print-header { font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; }
        .print-table { width: 100%; border-collapse: collapse; }
        .print-table th, .print-table td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        .print-table th { background-color: #f2f2f2; }
      }
    </style>

</head>
<body>
  
  <header class="fixed top-0 left-0 w-full bg-indigo-700 text-white shadow-xl z-20">
    <div class="flex items-center justify-between p-4 max-w-7xl mx-auto">
      <div class="flex items-center space-x-4">
        <button id="menu-toggle" class="md:hidden p-1 focus:outline-none focus:ring-2 focus:ring-white rounded-md">
          <i class="fas fa-bars text-xl"></i>
        </button>
        <div class="logo font-bold text-2xl tracking-tight">
          <a href="../../index.html" class="text-white hover:text-gray-200">TORONTO PRIMARY SCHOOL</a>
        </div>
      </div>
      
      <div class="relative group">
        <button class="flex items-center space-x-2 text-white p-2 rounded-full hover:bg-indigo-600 transition duration-150">
          <i class="fas fa-user-circle text-2xl"></i>
          <span class="hidden sm:inline">Admin</span>
          <i class="fas fa-chevron-down text-xs ml-1"></i>
        </button>

        <div class="absolute right-0 top-full mt-1 w-48 bg-white rounded-md shadow-lg py-1 z-30 invisible group-hover:visible opacity-0 group-hover:opacity-100 translate-y-1 group-hover:translate-y-0 transition-all duration-200">
          <a href="#profile" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" onclick="window.location.hash='#profile'; handleNavigation();">Profile</a>
          <hr class="my-1">
          <a href="../auth/auth.html" class="btn-logout block px-4 py-2 text-sm text-red-600 hover:bg-red-50"><i class="fas fa-sign-out-alt mr-2"></i>Logout</a>
        </div>
      </div>
    </div>
  </header>
  <main class="portal-main-content">
<aside class="sidebar">
      <h3 class="sidebar-title">Admin Menu</h3>
      <ul>
        <li><a href="#profile"><i class="fas fa-user-shield"></i> Your Profile</a></li>
        
        <li>
          <a href="#sams-mgmt-dashboard" class="group-title"><i class="fas fa-cogs"></i> SA-SAMS Management</a>
          <ul class="sub-menu">
            <li><a href="#sams-applications"><i class="fas fa-clipboard-check"></i> Accepted Applications</a></li>
            <li><a href="#sams-learners"><i class="fas fa-user-graduate"></i> Learner Management</a></li>
            <li><a href="#attendance-records"><i class="fas fa-calendar-times"></i> Attendance Records</a></li>
            <li><a href="#grade-assignment"><i class="fas fa-pencil-alt"></i> Class Assignment</a></li>
            <li><a href="#grade-sections"><i class="fas fa-layer-group"></i> Grade Sections</a></li>
            <li><a href="#mark-sheets"><i class="fas fa-award"></i> Mark Sheets</a></li>
            <li><a href="#report-cards"><i class="fas fa-file-invoice"></i> Report Cards</a></li>
            <li><a href="#sams-educators"><i class="fas fa-chalkboard-teacher"></i> Educator Management</a></li>
            <li><a href="#sams-parents"><i class="fas fa-users"></i> Parent Data</a></li>
          </ul>
        </li>
        <li><a href="#finance"><i class="fas fa-dollar-sign"></i> Finance</a></li>
        <li><a href="#school-calendar"><i class="fas fa-calendar-alt"></i> School Calendar</a></li>
        <li><a href="#announcements-mgmt"><i class="fas fa-bullhorn"></i> Announcements</a></li>
        <li><a href="#other-tools"><i class="fas fa-tools"></i> Other Tools</a></li>
        
        <li class="sidebar-footer-item">
          <a href="auth.html" class="btn-logout" style="color: var(--primary-red);"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </li>
      </ul>
    </aside>
    
    <div class="portal-content-wrapper">
      <h1 class="portal-title">Admins Portal Dashboard</h1>

      <!-- **NEW**: Shared action bar for buttons visible across multiple sections -->
      <div id="shared-actions-bar" style="margin-bottom: 20px; display: flex; gap: 10px;">
          <button id="open-bulk-remove-modal-btn" class="cta-button-small danger" style="display: none;">
              <i class="fas fa-user-minus"></i> Bulk Remove
          </button>
          <!-- Other shared buttons can be added here in the future -->
      </div>

      <section id="profile" class="portal-section active-section">
        <h2>Your Profile</h2>
        <div class="profile-card">
          <img src="../../images/placeholder-profile.png" alt="Admin Profile Picture" class="profile-pic">
          <div class="profile-details">
            <p><strong>Name:</strong> [Admin's Full Name]</p>
            <p><strong>Role:</strong> [Admin Role, e.g., Principal, Bursar]</p>
            <p><strong>Email:</strong> [Admin's Email Address]</p>
          </div>
        </div>
      </section>
      
      <section id="sams-mgmt-dashboard" class="portal-section">
        <h2>SA-SAMS Management Dashboard</h2>
        <p>Use the links below to access specific SA-SAMS modules.</p>
        
        <div class="grid-container" style="margin-top: 20px;">
          <div class="grid-item tool-card">
            <h3>Accepted Applications</h3>
            <p>Review and finalize all accepted learner applications for import.</p>
            <a href="#sams-applications" class="cta-button">Go to Applications</a>
          </div>
          <div class="grid-item tool-card">
            <h3>Learner Management</h3>
            <p>View and update learner details, attendance, and registration information.</p>
            <a href="#sams-learners" class="cta-button">Go to Learner Mgmt</a>
          </div>
          <div class="grid-item tool-card">
            <h3>Educator Management</h3>
            <p>Handle staff profiles, qualifications, and professional development records.</p>
            <a href="#sams-educators" class="cta-button">Go to Educator Mgmt</a>
          </div>
        </div>
      </section>
      
      <section id="sams-applications" class="portal-section">
        <h2>Accepted Applications (Ready for SA-SAMS)</h2>
        <div class="tool-card">
          <h3>Imported Learner Registrations (Offer Accepted)</h3>
          <p>This list displays applications that have been accepted and are ready for final import into the official SA-SAMS system. Data is pulled from the Firestore `sams_registrations` collection.</p>
          
          <table id="sams-data-table">
            <thead>
              <tr>
                <th>Adm No.</th>
                <th>Learner Name</th>
                <th>Grade</th>
                <th>Parent Email</th>
                <th>Imported At</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>

          <p class="data-status-message" id="sams-data-status">Loading accepted applications...</p>
        </div>
      </section>
      
      <section id="sams-learners" class="portal-section"> 
        <h2 id="lms-header">Learner Management System (LMS)</h2>
        
        <div id="learner-details-display" class="tool-card" style="display: none;">
          </div>

        <div class="tool-card all-learners-container" id="all-learners-list-view" style="margin-top: 15px;">
          
          <div class="lms-actions" style="margin-bottom: 20px; display: flex; gap: 10px;">
            <button id="show-add-learner-form" class="cta-button-small">
                <i class="fas fa-plus"></i> Add New Learner
            </button>
            <button id="show-remove-duplicates-tool" class="cta-button-small danger">
                <i class="fas fa-exclamation-triangle"></i> Find & Remove Duplicates
            </button>
          </div>
          <div id="all-active-learners-list" style="margin-top: 0;">
            <h3>Active Learners Summary</h3>
            
            <div class="export-actions" style="margin-bottom: 20px; display: flex; gap: 10px;">
                <button id="export-lms-excel-btn" class="cta-button-small primary-green"><i class="fas fa-file-excel"></i> Export to Excel</button>
                <button id="export-lms-pdf-btn" class="cta-button-small primary-red"><i class="fas fa-file-pdf"></i> Export to PDF</button>
            </div>

            <div class="filters-wrapper" style="display: flex; gap: 15px; align-items: flex-end; margin-bottom: 20px; flex-wrap: wrap;">
                <div class="form-group" style="flex: 1; min-width: 200px; margin-bottom: 0;">
                    <label for="grade-filter">Filter by Grade:</label>
                    <select id="grade-filter" style="padding: 10px; border: 1px solid #ccc; border-radius: 5px; width: 100%;">
                        <option value="All">All Grades (R - 7)</option>
                        <option value="R">Grade R</option>
                        <option value="1">Grade 1</option> 
                        <option value="2">Grade 2</option>
                        <option value="3">Grade 3</option>
                        <option value="4">Grade 4</option>
                        <option value="5">Grade 5</option>
                        <option value="6">Grade 6</option>
                        <option value="7">Grade 7</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 1; min-width: 200px; margin-bottom: 0;">
                    <label for="class-filter">Filter by Class:</label>
                    <select id="class-filter" style="padding: 10px; border: 1px solid #ccc; border-radius: 5px; width: 100%;" disabled>
                        <option value="All">All Classes</option>
                    </select>
                </div>
            </div>
            <table id="active-learners-table">
              <thead>
                <tr>
                  <th><input type="checkbox" id="select-all-active"></th>
                  <th>Adm No.</th>
                  <th>Name</th>
                  <th>Grade/Class</th> 
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                </tbody>
            </table>
            <div style="text-align: center; margin-top: 10px;">
                <button id="load-more-all-btn" class="cta-button-secondary" style="display: none;">Load More Learners</button>
            </div>
            <p class="data-status-message" id="active-learners-status">Loading all active learners...</p>
          </div>
        </div>

        <div id="add-learner-form-section" class="tool-card" style="display: none; margin-top: 20px;">
            <h3>Add a New Learner Manually</h3>
            <p>Use this form to create a new learner profile directly in the system.</p>
            <form id="add-learner-form">
                <div class="grid-container" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                    <div class="form-group">
                        <label for="new-admission-id">Admission ID (Unique)</label>
                        <input type="text" id="new-admission-id" required>
                    </div>
                    <div class="form-group">
                        <label for="new-learner-name">First Name</label>
                        <input type="text" id="new-learner-name" required>
                    </div>
                    <div class="form-group">
                        <label for="new-learner-surname">Last Name</label>
                        <input type="text" id="new-learner-surname" required>
                    </div>
                    <div class="form-group">
                        <label for="new-grade">Grade (R/1-7)</label>
                        <input type="text" id="new-grade" required style="text-transform: uppercase;" maxlength="1">
                    </div>
                </div>
                <p id="add-learner-status" class="status-message-box" style="display: none;"></p>
                <button type="submit" class="cta-button">
                    <i class="fas fa-user-plus"></i> Create Learner Profile
                </button>
            </form>
        </div>

        <div id="remove-duplicates-section" class="tool-card" style="display: none; margin-top: 20px;">
            <h3>Find & Remove Duplicate Learners</h3>
            <p>This tool scans for learners with identical admission numbers. Review the list below and remove any incorrect or outdated entries. This action is permanent.</p>
            <p class="data-status-message" id="duplicates-status">Click the button to start scanning for duplicates.</p>
            <button id="scan-for-duplicates-btn" class="cta-button" style="margin-top: 15px;">
                <i class="fas fa-search"></i> Scan for Duplicates
            </button>
            <div id="duplicates-results-container" style="margin-top: 20px;">
                <!-- Duplicate results will be rendered here -->
            </div>
        </div>

        <div id="remove-learner-section" class="tool-card" style="display: none; margin-top: 20px;">
            <!-- This section seems to be unused, but we'll leave it for now -->
        </div>

      </section>
      
      <section id="attendance-records" class="portal-section">
        <h2>Weekly Attendance Records</h2>
        <p>View learners who were marked absent. Data is submitted by teachers from their portals.</p>

        <div class="tool-card">
            <div class="filters-container" style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
                <div class="form-group" style="flex: 1; min-width: 150px;">
                    <label for="attendance-year-filter">Select Year:</label>
                    <select id="attendance-year-filter"></select>
                </div>
                <div class="form-group" style="flex: 1; min-width: 150px;">
                    <label for="attendance-term-filter">Select Term:</label>
                    <select id="attendance-term-filter">
                        <option value="1">Term 1 (Jan-Mar)</option>
                        <option value="2">Term 2 (Apr-Jun)</option>
                        <option value="3">Term 3 (Jul-Sep)</option>
                        <option value="4">Term 4 (Oct-Dec)</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 1; min-width: 200px;">
                    <label for="attendance-week-filter">Filter by Week:</label>
                    <select id="attendance-week-filter" disabled><option value="All">All Weeks in Term</option></select>
                </div>
                <div class="form-group" style="flex: 1; min-width: 200px;">
                    <label for="attendance-class-filter">Filter by Class:</label>
                    <select id="attendance-class-filter" disabled><option value="All">All Classes</option></select>
                </div>
            </div>

            <p class="data-status-message" id="attendance-records-status">Please select a date to view records.</p>
            <div id="attendance-records-container" class="data-table-container">
                <table id="attendance-records-table">
                    <thead>
                        <tr>
                            <th>Admission No.</th>
                            <th>Learner Name</th>
                            <th>Class</th>
                            <th id="attendance-table-header-absences">Total Days Absent This Term</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
      </section>

      <section id="grade-assignment" class="portal-section">
        <h2>Class Assignment Tool</h2>
        <p>Use this tool to assign learners to specific class sections (e.g., 2A, 2B, 2C).</p>
        
                <div class="assignment-view-switcher" style="margin-bottom: 20px;">
            <button id="view-unassigned-btn" class="cta-button-small active-view">Awaiting Assignment</button>
            <button id="view-assigned-btn" class="cta-button-small">Currently Assigned</button>
        </div>
                
                <div class="tool-card all-learners-container" id="unassigned-learners-list">
          <div id="unassigned-learners-list-inner" style="margin-top: 0;">
            <h3>Learners Awaiting Class Assignment</h3>

            <div class="form-group" style="max-width: 250px; margin-bottom: 20px;">
                <label for="assignment-grade-filter">Filter by Grade:</label>
                <select id="assignment-grade-filter" style="padding: 10px; border: 1px solid #ccc; border-radius: 5px; width: 100%;">
                    <option value="All">All Grades (R - 7)</option>
                    <option value="R">Grade R</option>
                    <option value="1">Grade 1</option> 
                    <option value="2">Grade 2</option>
                    <option value="3">Grade 3</option>
                    <option value="4">Grade 4</option>
                    <option value="5">Grade 5</option>
                    <option value="6">Grade 6</option>
                    <option value="7">Grade 7</option>
                </select>
            </div>

            <table id="unassigned-learners-table">
              <thead>
                <tr>
                  <th><input type="checkbox" id="select-all-unassigned"></th>
                  <th>Adm No.</th>
                  <th>Name</th>
                  <th>Grade</th> 
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                </tbody>
            </table>
            <p class="data-status-message" id="unassigned-learners-status">Loading unassigned learners...</p>
          </div>
        </div>

        <!-- Bulk Action Bar -->
        <div id="bulk-action-bar" class="bulk-action-bar" style="display: none;">
            <span id="bulk-action-count">0 learners selected</span>
            <div class="bulk-action-controls">
                <div class="form-group">
                    <label for="bulk-assign-section-select">Assign selected to:</label>
                    <select id="bulk-assign-section-select">
                        <option value="">-- Select a Class --</option>
                    </select>
                </div>
                <button id="bulk-assign-button" class="cta-button-small">
                    <i class="fas fa-check-double"></i> Assign
                </button>
            </div>
        </div>
                        <div class="tool-card all-learners-container" id="assigned-learners-list" style="display: none;">
          <h3>Active Class Assignments</h3>

          <div class="form-group" style="max-width: 250px; margin-bottom: 20px;">
              <label for="assigned-grade-filter">Filter by Grade:</label>
              <select id="assigned-grade-filter" style="padding: 10px; border: 1px solid #ccc; border-radius: 5px; width: 100%;">
                  <option value="All">All Grades (R - 7)</option>
                  <option value="R">Grade R</option>
                  <option value="1">Grade 1</option> 
                  <option value="2">Grade 2</option>
                  <option value="3">Grade 3</option>
                  <option value="4">Grade 4</option>
                  <option value="5">Grade 5</option>
                  <option value="6">Grade 6</option>
                  <option value="7">Grade 7</option>
              </select>
          </div>

          <table id="assigned-learners-table">
            <thead>
              <tr>
                <th><input type="checkbox" id="select-all-assigned"></th>
                <th>Adm No.</th>
                <th>Name</th>
                <th>Grade/Class</th> 
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
          <p class="data-status-message" id="assigned-learners-status">Loading assigned learners...</p>
        </div>
                
        <div id="assignment-details-display" class="tool-card" style="display: none; margin-top: 20px;">
          
        </div>

      </section>

      <section id="grade-sections" class="portal-section">
        <h2>Learners by Grade Section</h2>
        <p>Select a grade to view all learners currently assigned to it.</p>
        
        <div class="grade-section-filters" style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
            <div class="form-group" style="flex: 1; min-width: 200px;">
                <label for="grade-section-grade-filter">Filter by Grade</label>
                <select id="grade-section-grade-filter">
                    <option value="">-- Select a Grade --</option>
                    <option value="R">Grade R</option>
                    <option value="1">Grade 1</option>
                    <option value="2">Grade 2</option>
                    <option value="3">Grade 3</option>
                    <option value="4">Grade 4</option>
                    <option value="5">Grade 5</option>
                    <option value="6">Grade 6</option>
                    <option value="7">Grade 7</option>
                </select>
            </div>
            <div class="form-group" style="flex: 1; min-width: 200px;">
                <label for="grade-section-class-filter">Filter by Class</label>
                <select id="grade-section-class-filter" disabled>
                    <option value="All">All Classes</option>
                </select>
            </div>
        </div>

        <div id="grade-section-display" class="tool-card">
            <h3 id="grade-section-header">Select a Grade to Begin</h3>
            
            <div class="export-actions" style="margin-top: 15px; margin-bottom: 20px; display: flex; gap: 10px;">
                <button id="export-grade-section-excel-btn" class="cta-button-small primary-green"><i class="fas fa-file-excel"></i> Export to Excel</button>
                <button id="export-grade-section-pdf-btn" class="cta-button-small primary-red"><i class="fas fa-file-pdf"></i> Export to PDF</button>
            </div>

            <table id="grade-section-learners-table">
                <thead>
                    <tr>
                        <th>Adm No.</th>
                        <th>Name</th>
                        <th>Current Class</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <p class="data-status-message" id="grade-section-learners-status">Please select a grade from the buttons above.</p>
        </div>
      </section>

      <section id="mark-sheets" class="portal-section">
        <h2>Generate Academic Mark Sheets</h2>
        <div class="tool-card">
            <div class="grade-management-header" style="display: flex; gap: 20px; align-items: flex-end; margin-bottom: 20px;">
                <div class="form-group" style="flex: 1;">
                    <label for="admin-marksheet-class-select">Select Class:</label>
                    <select id="admin-marksheet-class-select">
                        <option value="">-- Loading Classes... --</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="admin-marksheet-subject-select">Select Subject:</label>
                    <select id="admin-marksheet-subject-select" disabled>
                        <option value="">-- Select Class First --</option>
                    </select>
                </div>
            </div>

            <div id="admin-gradebook-container" style="display: none;">
                <div class="gradebook-header-actions">
                    <h3 id="admin-gradebook-header">Gradebook</h3>
                    <button id="admin-generate-marksheet-btn" class="cta-button-small primary-green" style="display: none;">
                        <i class="fas fa-print"></i> Generate Mark Sheet
                    </button>
                </div>
                <div id="admin-gradebook-table-container" class="data-table-container"></div>
                <p id="admin-gradebook-status" class="data-status-message">Select a class and subject to load the gradebook.</p>
            </div>
        </div>
      </section>

      <!-- Modal for Printable Mark Sheet (re-used from teacher portal) -->
      <div id="marksheet-modal" class="modal">
          <div id="marksheet-modal-content" class="modal-content printable-area"></div>
      </div>

      <section id="sams-educators" class="portal-section">
          <h2>Educator Management System</h2>
          
          <div id="all-teachers-list" class="data-list-container">
              <div class="form-group" style="max-width: 250px; margin-bottom: 20px;">
                  <label for="teacher-grade-filter">Filter by Assigned Grade:</label>
                  <select id="teacher-grade-filter" style="padding: 10px; border: 1px solid #ccc; border-radius: 5px; width: 100%;">
                      <option value="All">All Grades</option>
                      <option value="R">Grade R</option>
                      <option value="1">Grade 1</option>
                      <option value="2">Grade 2</option>
                      <option value="3">Grade 3</option>
                      <option value="4">Grade 4</option>
                      <option value="5">Grade 5</option>
                      <option value="6">Grade 6</option>
                      <option value="7">Grade 7</option>
                  </select>
              </div>
              <p id="teachers-data-status" class="status-message">Loading...</p>
              
              <div class="overflow-x-auto">
                  <table id="teachers-data-table" class="min-w-full divide-y divide-gray-200">
                      <thead>
                          <tr>
                              <th>Name</th> 
                              <th>Email</th>
                              <th>Assigned Grade/Subject</th>
                              <th>Action</th>
                          </tr>
                      </thead>
                      <tbody>
                          </tbody>
                  </table>
              </div>
              
              <button id="load-more-teachers-btn" class="cta-button-secondary" style="display: none; margin-top: 15px;">
                  Load More Educators
              </button>
          </div>
          
          <div id="teacher-details-display" class="details-view-container" style="display: none;">
              </div>
      </section>

      <section id="mark-sheets" class="portal-section">
        <h2>Generate Academic Mark Sheets</h2>
        <div class="tool-card">
            <div class="grade-management-header" style="display: flex; gap: 20px; align-items: flex-end; margin-bottom: 20px;">
                <div class="form-group" style="flex: 1;">
                    <label for="admin-marksheet-class-select">Select Class:</label>
                    <select id="admin-marksheet-class-select">
                        <option value="">-- Loading Classes... --</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="admin-marksheet-subject-select">Select Subject:</label>
                    <select id="admin-marksheet-subject-select" disabled>
                        <option value="">-- Select Class First --</option>
                    </select>
                </div>
            </div>

            <div id="admin-gradebook-container" style="display: none;">
                <div class="gradebook-header-actions">
                    <h3 id="admin-gradebook-header">Gradebook</h3>
                    <button id="admin-generate-marksheet-btn" class="cta-button-small primary-green" style="display: none;">
                        <i class="fas fa-print"></i> Generate Mark Sheet
                    </button>
                </div>
                <div id="admin-gradebook-table-container" class="data-table-container"></div>
                <p id="admin-gradebook-status" class="data-status-message">Select a class and subject to load the gradebook.</p>
            </div>
        </div>
      </section>

      <!-- Modal for Printable Mark Sheet (re-used from teacher portal) -->
      <div id="marksheet-modal" class="modal">
          <div id="marksheet-modal-content" class="modal-content printable-area"></div>
      </div>

      <section id="report-cards" class="portal-section">
        <h2>Report Card Generation</h2>
        <div class="tool-card">
            <h3>Generate Learner Report Card</h3>
            <p>Select a class, learner, and term to generate a report card. The generated report will be saved and made available to the learner and their parents.</p>
            
            <div class="filters-container" style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; align-items: flex-end;">
                <div class="form-group" style="flex: 1; min-width: 200px;">
                    <label for="report-card-class-filter">1. Select Class</label>
                    <select id="report-card-class-filter"><option value="">-- Select a Class --</option></select>
                </div>
                <div class="form-group" style="flex: 1; min-width: 200px;">
                    <label for="report-card-learner-filter">2. Select Learner</label>
                    <select id="report-card-learner-filter" disabled><option value="">-- Select Class First --</option></select>
                </div>
                <div class="form-group" style="flex: 1; min-width: 150px;">
                    <label for="report-card-term-filter">3. Select Term</label>
                    <select id="report-card-term-filter">
                        <option value="1">Term 1</option>
                        <option value="2">Term 2</option>
                        <option value="3">Term 3</option>
                        <option value="4">Term 4</option>
                    </select>
                </div>
                 <div class="form-group" style="flex: 1; min-width: 150px;">
                    <label for="report-card-year-filter">4. Select Year</label>
                    <input type="number" id="report-card-year-filter" value="2024" min="2020">
                </div>
                <button id="generate-report-card-btn" class="cta-button primary-blue"><i class="fas fa-cogs"></i> Generate</button>
            </div>
            <div id="report-card-preview-container" class="printable-area"></div>
        </div>
      </section>

      <section id="sams-parents" class="portal-section">
        <h2>Parent Data Management</h2>
        <p>This section displays parent information linked to registered learners, sourced from the <code>sams_registrations</code> collection.</p>
        <div class="tool-card">
          <h3>All Parent Contacts</h3>
          <p>Use the filter to find parents by the grade of their learner.</p>

          <div class="filters-container" style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
            <div class="form-group" style="flex: 1; min-width: 200px;">
                <label for="parent-grade-filter">Filter by Learner Grade:</label>
                <select id="parent-grade-filter">
                    <option value="All">All Grades (R - 7)</option>
                    <option value="R">Grade R</option>
                    <option value="1">Grade 1</option> 
                    <option value="2">Grade 2</option>
                    <option value="3">Grade 3</option>
                    <option value="4">Grade 4</option>
                    <option value="5">Grade 5</option>
                    <option value="6">Grade 6</option>
                    <option value="7">Grade 7</option>
                </select>
            </div>
            <div class="form-group" style="flex: 1; min-width: 200px;">
                <label for="parent-class-filter">Filter by Class:</label>
                <select id="parent-class-filter" disabled>
                    <option value="All">All Classes</option>
                </select>
            </div>
          </div>

          <p class="data-status-message" id="parents-data-status">Please select a filter to load parent data.</p>
          <div id="parents-data-container"></div>
        </div>
      </section>

      <section id="edit-teacher-profile" class="portal-section">
          <!-- Content will be dynamically injected by showEditTeacherForm() in ui-handlers.js -->
      </section>
      
      <section id="finance" class="portal-section">
        <h2>Finance</h2>
        <div class="tool-card">
          <p>Oversee all school financial activities, including fee payments, budgets, and reporting.</p>
          <a href="#" class="cta-button">Go to Finance</a>
        </div>
      </section>
      
      <section id="announcements-mgmt" class="portal-section">
        <h2>Manage Announcements</h2>
        <p>Create new announcements to publish on the school website.</p>
        <div class="announcement-form-container">
          <form id="new-announcement-form">
            <div class="form-group">
              <label for="announcement-title">Title</label>
              <input type="text" id="announcement-title" name="title" required>
            </div>
            <div class="form-group">
              <label for="announcement-content">Content</label>
              <textarea id="announcement-content" name="content" rows="6" required></textarea>
            </div>
            <div class="form-group">
              <label for="announcement-date">Date</label>
              <input type="date" id="announcement-date" name="date" required>
            </div>
            <div class="form-group">
              <label for="announcement-duration">Visible For (days)</label>
              <input type="number" id="announcement-duration" name="duration" min="1" value="7" required>
              <small>The announcement will be automatically removed after this many days from its display date.</small>
            </div>
            <button type="submit" class="cta-button">Publish Announcement</button>
          </form>
        </div>

        <div class="tool-card" style="margin-top: 30px;">
            <h3>Current & Upcoming Announcements</h3>
            <p>Manually delete announcements if needed. Expired announcements are removed automatically.</p>
            <div id="current-announcements-list">
                <p class="data-status-message" id="current-announcements-status">Loading announcements...</p>
                <!-- Announcements will be loaded here -->
            </div>
        </div>
      </section>

      <section id="school-calendar" class="portal-section">
        <div class="tool-card" style="margin-top: 20px;">
            <div class="ap-header" style="border-bottom: 1px solid #e5e7eb; padding-bottom: 1rem; margin-bottom: 1rem;">
                <div class="ap-title">
                    <i class="fas fa-university" style="color: var(--primary-indigo);"></i>
                    <div>
                        <h1>Official School Calendar Management</h1>
                        <p>Set the term dates and holidays for the entire school. This will be visible to all teachers.</p>
                    </div>
                </div>
                <button id="save-official-calendar-btn" class="cta-button primary-green">
                    <i class="fas fa-save"></i> Save Official Calendar
                </button>
            </div>

            <!-- Status message container for save/validation feedback -->
            <p id="official-calendar-status" class="status-message-box" style="margin-bottom: 1rem; display: none;"></p>

            <!-- Term Tabs and Details Container -->
            <div id="official-cal-term-tabs" class="ap-tabs">
                <!-- Tabs will be rendered here by JS -->
                <p class="info-message">Loading calendar editor...</p>
            </div>
            <div id="official-cal-term-details">
                <!-- Term details form will be rendered here by JS -->
            </div>
        </div>
      </section>

      <section id="other-tools" class="portal-section">
        <h2>Other Administrative Tools</h2>
        <div class="grid-container">
          <div class="grid-item tool-card">
            <h3>Announcements</h3>
            <p>Create and publish new announcements for parents, teachers, and learners.</p>
            <a href="#announcements-mgmt" class="cta-button">Manage Announcements</a>
          </div>
          <div class="grid-item tool-card">
            <h3>System Configuration</h3>
            <p>Adjust and configure system settings and user permissions.</p>
            <a href="#" class="cta-button">Go to Settings</a>
          </div>
          <div class="grid-item tool-card">
            <h3>Database Organization</h3>
            <p>Generate the "Class View" collection in Firebase. This organizes learners into documents per class (e.g., "Grade 7C") for easier browsing in the console.</p>
            <button id="rebuild-class-views-btn" class="cta-button primary-blue">
                <i class="fas fa-sync"></i> Rebuild Class Views
            </button>
          </div>
        </div>
      </section>
    </div>

    <!-- Modal for Printable Mark Sheet (re-used from teacher portal) -->
    <div id="marksheet-modal" class="modal">
        <div id="marksheet-modal-content" class="modal-content printable-area"></div>
    </div>

    <!-- Bulk Remove Learners Modal -->
    <div id="bulk-remove-modal" class="modal">
      <div class="modal-content" style="max-width: 600px;">
          <span class="modal-close-btn" id="close-bulk-remove-modal">&times;</span>
          <h3>Bulk Remove Learners from Class</h3>
          <p>Select a class, then select learners to unassign them (remove from class roster).</p>
          
          <div class="form-group">
              <label for="bulk-remove-class-select">Select Class:</label>
              <select id="bulk-remove-class-select" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;">
                  <option value="">-- Select Class --</option>
              </select>
          </div>

          <div class="form-group">
              <input type="text" id="bulk-remove-search" placeholder="Search learner name..." style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; display:none;">
          </div>

          <div id="bulk-remove-list-container" class="scroll-container" style="max-height: 300px; overflow-y: auto; border: 1px solid #eee; padding: 10px; text-align: left; margin-bottom: 15px;">
              <p class="info-message">Please select a class first.</p>
          </div>

          <div style="margin-bottom: 15px; padding: 10px; background-color: #fee2e2; border-radius: 4px; border: 1px solid #fca5a5;">
              <input type="checkbox" id="bulk-delete-permanent"> 
              <label for="bulk-delete-permanent" style="color: #991b1b; font-weight: bold; cursor: pointer;">Permanently delete these learners from the database?</label>
          </div>

          <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                  <input type="checkbox" id="select-all-bulk-remove" disabled> <label for="select-all-bulk-remove">Select All</label>
              </div>
              <button id="execute-bulk-remove-btn" class="cta-button danger" disabled>
                  <i class="fas fa-trash-alt"></i> Remove Selected (<span id="bulk-remove-count">0</span>)
              </button>
          </div>
      </div>
    </div>

    <!-- Image Viewer Modal -->
    <div id="image-viewer-modal" class="image-viewer-modal">
        <span class="image-viewer-close">&times;</span>
        <img class="image-viewer-content" id="modal-image-content">
    </div>

  </main>

  <!-- Container for printing content -->
  <div id="print-container" style="display: none;"></div>

  <footer>
    <p>© 2023 Toronto Primary School. All rights reserved.</p>
    <a href="#"><i class="fa-brands fa-x-twitter"></i></a>
    <a href="#"><i class="fa-brands fa-facebook-f"></i></a>
    <a href="#"><i class="fa-brands fa-instagram"></i></a>
    <a href="#"><i class="fa-brands fa-linkedin-in"></i></a>
    <a href="#"><i class="fa-brands fa-square-youtube"></i></a>
  </footer>
    <!-- firebase compat libs already included in head -->
    <!-- load firebase-config and portal scripts as plain scripts (they expect globals) -->

</body>
</html>